name: Set up AWS SDK with Auth
description: Using OIDC AWS Credentials and login Amazon ECR

inputs:
    environment:
        description: Target environment to deploy.
        required: true

runs:
    using: 'composite'
    steps:
        - name: OIDC AWS Credentials
          uses: aws-actions/configure-aws-credentials@v3
          env:
              aws_credentials_role: |
                  {
                    "dev": "arn:aws:iam::340258365836:role/oidc-github-actions-dev-role",
                    "sb": "arn:aws:iam::309217545237:role/oidc-github-actions-sb-role",
                    "game": "arn:aws:iam::340258365836:role/oidc-github-actions-dev-role",
                    "prd": "arn:aws:iam::045372454064:role/oidc-github-actions-prd-role"
                  }
          with:
              aws-region: 'us-west-2'
              role-to-assume: ${{ fromJSON(env.aws_credentials_role)[inputs.environment] }}
              audience: sts.amazonaws.com

        - name: Configure AWS CLI Profile
          run: |
              aws configure set region us-west-2
              aws configure set role_arn ${{ fromJSON(env.aws_credentials_role)[inputs.environment] }}
              aws configure set source_profile ${{ inputs.environment }}
          shell: bash
          env:
              AWS_PROFILE: ${{ inputs.environment }}
